from evdev import InputDevice, list_devices, categorize, ecodes
from gpiozero import PWMOutputDevice, OutputDevice
import smbus2
import struct
import csv
import time

# GPIO Pin Definitions
ENA = PWMOutputDevice(12)  # PWM for right motors
ENB = PWMOutputDevice(13)  # PWM for left motors
IN1 = OutputDevice(17)  # Right motor reverse
IN2 = OutputDevice(18)  # Right motor forward
IN3 = OutputDevice(27)  # Left motor reverse
IN4 = OutputDevice(22)  # Left motor forward

# I2C Settings
ARDUINO_ADDRESS = 0x08  # Arduino's I2C slave address
bus = smbus2.SMBus(1)   # Use I2C bus 1 (default for Raspberry Pi)

# CSV File Setup
csv_file = "rover_data_log.csv"
with open(csv_file, mode='w', newline='') as file:
    writer = csv.writer(file)
    writer.writerow(["Left Motor Speed", "Right Motor Speed", "Direction",
                     "IMU1_Accel_X", "IMU1_Accel_Y", "IMU1_Accel_Z",
                     "IMU1_Gyro_X", "IMU1_Gyro_Y", "IMU1_Gyro_Z",
                     "IMU2_Accel_X", "IMU2_Accel_Y", "IMU2_Accel_Z",
                     "IMU2_Gyro_X", "IMU2_Gyro_Y", "IMU2_Gyro_Z",
                     "Sensor 1", "Sensor 2", "Sensor 3", "Sensor 4", "Sensor 5", "Sensor 6"])


def map_value(value, in_min, in_max, out_min, out_max):
    """Map a joystick value to motor speed."""
    mapped_value = int((value - in_min) * (out_max - out_min) / (in_max - in_min) + out_min)
    if -10 <= mapped_value <= 10:  # Dead zone
        return 0
    return mapped_value


def set_motor_speed(motor_pwm, motor_fwd, motor_rev, speed):
    """Set the motor speed and direction."""
    if speed > 0:
        motor_fwd.on()
        motor_rev.off()
        motor_pwm.value = abs(speed) / 255.0
    elif speed < 0:
        motor_fwd.off()
        motor_rev.on()
        motor_pwm.value = abs(speed) / 255.0
    else:
        motor_fwd.off()
        motor_rev.off()
        motor_pwm.value = 0


def read_from_arduino():
    """Reads IMU and sensor data from Arduino in chunks."""
    try:
        # Read IMU1 data (first chunk)
        data = bus.read_i2c_block_data(ARDUINO_ADDRESS, 0, 18)
        imu1_accel = struct.unpack(">hhh", bytes(data[:6]))
        imu1_gyro = struct.unpack(">hhh", bytes(data[6:12]))

        # Read IMU2 data (second chunk)
        data = bus.read_i2c_block_data(ARDUINO_ADDRESS, 0, 18)
        imu2_accel = struct.unpack(">hhh", bytes(data[:6]))
        imu2_gyro = struct.unpack(">hhh", bytes(data[6:12]))

        # Read sensor data (third chunk)
        data = bus.read_i2c_block_data(ARDUINO_ADDRESS, 0, 18)
        sensors = [struct.unpack(">H", bytes(data[i:i+2]))[0] for i in range(0, 18, 2)]

        return imu1_accel, imu1_gyro, imu2_accel, imu2_gyro, sensors
    except Exception as e:
        print(f"Error reading from Arduino: {e}")
        return None, None, None, None, None


def find_ps4_controller():
    devices = [InputDevice(path) for path in list_devices()]
    for device in devices:
        if 'Wireless Controller' in device.name:
            return device
    return None


def log_to_csv(left_speed, right_speed, direction, imu1_accel, imu1_gyro, imu2_accel, imu2_gyro, sensors):
    with open(csv_file, mode='a', newline='') as file:
        writer = csv.writer(file)
        writer.writerow([left_speed, right_speed, direction,
                         *imu1_accel, *imu1_gyro,
                         *imu2_accel, *imu2_gyro,
                         *sensors])


def main():
    ps4_controller = find_ps4_controller()

    if not ps4_controller:
        print("PS4 controller not found. Make sure it is connected via Bluetooth.")
        return

    print(f"Controller found: {ps4_controller.name}")
    left_y = 0
    right_y = 0

    try:
        for event in ps4_controller.read_loop():
            if event.type == ecodes.EV_ABS:
                absevent = categorize(event)

                # Map joystick inputs to motor values
                if event.code == ecodes.ABS_Y:  # Left stick (vertical)
                    left_y = map_value(absevent.event.value, 0, 255, -255, 255)
                    print(f"Left stick value: {left_y}")
                elif event.code == ecodes.ABS_RY:  # Right stick (vertical)
                    right_y = map_value(absevent.event.value, 0, 255, -255, 255)
                    print(f"Right stick value: {right_y}")

                # Set motor speeds based on joystick values
                set_motor_speed(ENB, IN3, IN4, left_y)  # Left motor
                set_motor_speed(ENA, IN1, IN2, right_y)  # Right motor

                # Determine direction
                if left_y > 0 and right_y > 0:
                    direction = "Backward"
                elif left_y < 0 and right_y < 0:
                    direction = "Forward"
                elif left_y > 0 and right_y < 0:
                    direction = "Right"
                elif left_y < 0 and right_y > 0:
                    direction = "Left"
                else:
                    direction = "Stopped"

                # Read Arduino IMU and sensor data
                imu1_accel, imu1_gyro, imu2_accel, imu2_gyro, sensors = read_from_arduino()

                if imu1_accel and imu1_gyro and imu2_accel and imu2_gyro and sensors:
                    # Log all data to CSV
                    log_to_csv(left_y, right_y, direction, imu1_accel, imu1_gyro, imu2_accel, imu2_gyro, sensors)

                    # Print data to terminal for debugging
                    print(f"\nDirection: {direction}")
                    print(f"IMU1 Accel: X={imu1_accel[0]}, Y={imu1_accel[1]}, Z={imu1_accel[2]}")
                    print(f"IMU1 Gyro: X={imu1_gyro[0]}, Y={imu1_gyro[1]}, Z={imu1_gyro[2]}")
                    print(f"IMU2 Accel: X={imu2_accel[0]}, Y={imu2_accel[1]}, Z={imu2_accel[2]}")
                    print(f"IMU2 Gyro: X={imu2_gyro[0]}, Y={imu2_gyro[1]}, Z={imu2_gyro[2]}")
                    print(f"Arduino Sensors: {sensors}")
                else:
                    print("Failed to read data from Arduino.")

    except KeyboardInterrupt:
        print("Stopping motors and exiting.")
        set_motor_speed(ENB, IN3, IN4, 0)
        set_motor_speed(ENA, IN1, IN2, 0)


if __name__ == "__main__":
    main()
